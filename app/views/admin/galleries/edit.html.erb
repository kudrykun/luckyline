<div class="container">
  <script>

      tinymce.init({
          selector: '#gallery_description',
          plugins: 'image link lists print ' +
                    'preview searchreplace visualblocks ' +
                    'fullscreen insertdatetime media ' +
                    'table contextmenu paste code',
          toolbar: 'bold italic | undo redo | ' +
                    'alignleft aligncenter alignright alignjustify | ' +
                    'bullist numlist outdent indent | paste | image | link | mybutton | myrow',
          style_formats: [
              { title: 'Колонка 3 из 12', block: 'div', classes: 'col-md-3'}
          ],
          // enable title field in the Image dialog
          image_title: true,
          // enable automatic uploads of images represented by blob or data URIs
          automatic_uploads: true,
          // URL of our upload handler (for more details check: https://www.tinymce.com/docs/configure/file-image-upload/#images_upload_url)
          images_upload_url: '<%=description_pictures_path%>',
          // here we add custom filepicker only to Image dialog
          file_picker_types: 'image',
          // and here's our custom image picker

          file_picker_callback: function(cb, value, meta) {

              (function() {
                  var send = XMLHttpRequest.prototype.send,
                      token = $('meta[name=csrf-token]').attr('content');
                  XMLHttpRequest.prototype.send = function(data) {
                      this.setRequestHeader('X-CSRF-Token', token);
                      return send.apply(this, arguments);
                  };
              }());

              var input = document.createElement('input');
              input.setAttribute('type', 'file');
              input.setAttribute('accept', 'image/*');

              // Note: In modern browsers input[type="file"] is functional without
              // even adding it to the DOM, but that might not be the case in some older
              // or quirky browsers like IE, so you might want to add it to the DOM
              // just in case, and visually hide it. And do not forget do remove it
              // once you do not need it anymore.

              input.onchange = function() {
                  var file = this.files[0];

                  var reader = new FileReader();
                  reader.readAsDataURL(file);
                  reader.onload = function () {
                      // Note: Now we need to register the blob in TinyMCEs image blob
                      // registry. In the next release this part hopefully won't be
                      // necessary, as we are looking to handle it internally.
                      var id = 'blobid' + (new Date()).getTime();
                      var blobCache =  tinymce.activeEditor.editorUpload.blobCache;
                      var base64 = reader.result.split(',')[1];
                      var blobInfo = blobCache.create(id, file, base64);
                      blobCache.add(blobInfo);

                      // call the callback and populate the Title field with the file name
                      cb(blobInfo.blobUri(), { title: file.nasme });
                  };
              };

              input.click();
          },
          setup: function(editor) {
              editor.addButton('mybutton', {
                  text: "Обернуть изображение",
                  onclick: function () {
                      var content = editor.selection.getContent();
                      if (content.match('<img.*\/>')) {
                          var regex = /src=["']?((?:.(?!["']?\s+(?:\S+)=|[>"']))+.)["']?/g;
                          var src = '/' + regex.exec(editor.selection.getContent())[1].replace(/\.\.\//g,'');
                          content.replace(/width="\d*"/g, '');
                          content.replace(/height="\d*"/g, '');
                          content.replace(/<img/g, '<img class="img-responsive"');
                          editor.selection.setContent(
                              '<div class="col-xs-6 col-sm-6 col-md-4 col-lg-3 text-center">' +
                                '<div class="catalog-gallery-container">' +
                                  '<a data-toggle="lightbox" data-gallery="description-pictures" href="'+ src +'">' +
                                    content  +
                                  '</a>' +
                                '</div>' +
                              '</div>'
                          );
                          /*editor.selection.wrap('<a data-toggle="lightbox" data-gallery="description-pictures" href="'+  src + '"></a>');*/
                        /* editor.insertContent(
                          '<div class="col-xs-6 col-sm-6 col-md-4 col-lg-3 text-center">' +
                          '<div class="catalog-gallery-container">' +
                          '<a data-toggle="lightbox" data-gallery="description-pictures" href="#">' +
                          '<img class="img-responsive" src="ссыль" alt="1000x1920">' +
                          '<div class="gallery-image-caption"></div>' +
                          '</a>' +
                          '</div>' +
                          '</div>'
                      );*/
                      }
                      else
                          alert("ВОУ! ДА ВЕДЬ НИЧЕГО НЕ ПРОИЗОШЛО!");
                  }
              });
              editor.addButton('myrow', {
                  text: "Контейнер для изображений",
                  onclick: function () {
                      editor.selection.setContent('<div class="row"></div>');
                  }
              });
          }
      });
  </script>
  <div class="row">
    <div class="col-md-12">
      <h1 class="page-header">Редактировать галерею</h1>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <%= form_for ([:admin, @gallery]), :html => {multipart: true} do |f| %>

          <div class="checkbox">
            <%= f.label :visible do %>
                <%= f.check_box :visible %>
                Видимость
            <% end %>
          </div>

          <% if @gallery.errors.any? %>
              <div id="error_explanation">
                <h2><%= pluralize(@gallery.errors.count, "error") %> prohibited this gallery from being saved:</h2>

                <ul>
                  <% @gallery.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
          <% end %>

          <div class="form-group">
            <%= f.label :title, 'Название' %>
            <%= f.text_field :title, class: 'form-control' %>
          </div>
          <div class="form-group">
            <%= f.label :description, 'Описание' %>
            <%= f.text_area :description, :class => "tinymce", :rows => 40, :cols => 120 %>
            <%= tinymce %>
          </div>
          <div class="form-group">
            <%= f.label :header, 'Заголовок H1' %>
            <%= f.text_field :header, class: 'form-control' %>
          </div>
          <div class="form-group">
            <%= f.label :category_id, 'Категория' %>
            <%= f.collection_select :category_id, @categories.order(:id), :id, :title, class: 'form-control' %>
          </div>
          <div class="form-group">
            <%= f.label :meta_title, 'Мета-название' %>
            <%= f.text_field :meta_title, class: 'form-control' %>
          </div>
          <div class="form-group">
            <%= f.label :meta_description, 'Мета-описание' %>
            <%= f.text_area :meta_description, class: 'form-control' %>
          </div>
          <div class="form-group">
            <%= f.label :preview, 'Изображение-превью' %>
            <% if @gallery.preview %>
                <div class="row">
                  <div class="col-md-3">
                    <div class="image-wrapper">
                      <%= link_to admin_picture_path(@gallery.preview), method: :delete, :remote => true, :class => 'delete-image' do %>
                          <div class="image-hover">
                            <div class="image-hover-content">
                              <%= icon ('times') %>
                            </div>
                          </div>
                          <div class="image-container">
                            <div class="image">
                              <%= image_tag @gallery.preview.image(:for_grid), class: 'img-responsive' %>

                            </div>
                          </div>
                      <% end %>
                    </div>
                  </div>
                </div>
            <% end %>
            <%= file_field_tag "preview", class: 'form-control' %>
          </div>
          <div class="checkbox">
            <label>
              <%= f.check_box :wide %> Широкое превью
            </label>
          </div>
          <div class="checkbox">
            <label>
              <%= f.check_box :half_wide %> Полуширокое превью
            </label>
          </div>
          <div class="form-group">
            <%= f.label :pictures, 'Изображения' %>
            <div class="row">
              <div class="col-md-12">
                Всего изображений: <%= @gallery.pictures.size %>
              </div>
            </div>
            <div class="row">
              <% @gallery.pictures.each do |picture| %>
                  <div class="col-md-2">
                    <div class="image-wrapper">
                      <%= link_to admin_picture_path(picture), method: :delete, :remote => true, :class => 'delete-image' do %>
                          <div class="image-hover">
                            <div class="image-hover-content">
                              <%= icon ('times') %>
                            </div>
                          </div>
                          <div class="image-container">
                            <div class="image">
                              <%= image_tag picture.image(:for_grid), class: 'img-responsive' %>
                            </div>
                          </div>
                      <% end %>
                    </div>
                  </div>
              <% end %>
            </div>
            <%= file_field_tag "images[]", type: :file, multiple: true %>
          </div>

          <div class="row">
            <%= f.submit 'Сохранить изменения', class: 'btn btn-default' %>
            <%= link_to 'Назад', admin_galleries_path, class: 'btn btn-default' %>
            <%= link_to 'Удалить', admin_gallery_path(@gallery), method: :delete, data: {confirm: 'Вы уверены?'}, class: 'btn btn-default' %>
          </div>
      <% end %>
    </div>
  </div>
</div>